<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#6b5bff" />
  <title>El Laboratorio de las Palabras M√°gicas</title>
  <meta name="description" content="Juego educativo para 2¬∞ de primaria: crea mensajes respetuosos en un foro escolar. SPA, accesible, offline y sin librer√≠as externas." />
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 128 128'%3E%3Cpath fill='%236b5bff' d='M64 6a26 26 0 0 1 26 26v6h6a26 26 0 0 1 0 52H79l-15 31-15-31H32a26 26 0 0 1 0-52h6v-6A26 26 0 0 1 64 6z'/%3E%3C/svg%3E" />
  <style>
    :root{
      --bg:#0f1226;
      --bg-soft:#171a36;
      --panel:#1f2350;
      --accent:#6b5bff;
      --accent-2:#3ddc97;
      --accent-3:#ffcc00;
      --danger:#ff5b6b;
      --text:#f3f5ff;
      --muted:#c7c9e8;
      --shadow: 0 12px 30px rgba(0,0,0,.3);
      --radius:20px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:radial-gradient(1200px 800px at 80% -10%, rgba(107,91,255,.25), transparent 60%),
      radial-gradient(900px 600px at -10% 110%, rgba(61,220,151,.18), transparent 55%), var(--bg);
      color:var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, 'Noto Sans', 'Helvetica Neue', Arial;
      line-height:1.35; display:flex; flex-direction:column; min-height:100vh;
    }
    header, footer{padding:12px 16px}
    header{position:sticky; top:0; z-index:20; background: linear-gradient(180deg, rgba(15,18,38,.95), rgba(15,18,38,.7)); backdrop-filter: blur(6px);}
    .row{display:flex; gap:12px; align-items:center; flex-wrap:wrap}
    h1{font-size: clamp(1.2rem, 2.4vw, 1.8rem); margin:0; display:flex; align-items:center; gap:8px;}
    .badge{font-size:.85rem; background:var(--panel); padding:6px 10px; border-radius:999px; color:var(--muted)}
    .btn{cursor:pointer; border:none; border-radius:14px; padding:10px 14px; background:var(--accent); color:white; font-weight:700; box-shadow:var(--shadow); transition: transform .06s ease, filter .2s ease}
    .btn.secondary{background:var(--panel); color:var(--text)}
    .btn.ghost{background:transparent; border:1px solid rgba(255,255,255,.15)}
    .btn:active{transform: translateY(1px)}
    .btn[disabled]{opacity:.6; cursor:not-allowed}
    main{flex:1; display:grid; grid-template-columns: 330px 1fr 360px; gap:14px; padding:14px;}
    @media (max-width: 1000px){
      main{grid-template-columns: 1fr; grid-template-rows: auto auto auto}
      #rightPanel{order:3}
      #centerPanel{order:2}
      #leftPanel{order:1}
    }
    .panel{background:linear-gradient(180deg, rgba(31,35,80,.92), rgba(31,35,80,.85)); border:1px solid rgba(255,255,255,.08); border-radius: var(--radius); box-shadow: var(--shadow); padding:14px}
    .panel h2{margin:.2rem 0 .6rem; font-size:1.1rem}
    .rule-list{display:flex; flex-direction:column; gap:8px}
    .rule{display:flex; gap:10px; align-items:flex-start; background: rgba(255,255,255,.05); padding:10px; border-radius:12px; border: 1px dashed rgba(255,255,255,.15)}
    .rule .emoji{font-size:1.2rem}

    /* Left Panel */
    .avatar-wrap{display:flex; gap:10px; align-items:center}
    .avatar{width:64px; height:64px; border-radius:50%; background:linear-gradient(135deg, #6b5bff, #9a8cff); display:grid; place-items:center; font-size:28px}
    .msg{background: rgba(0,0,0,.2); border:1px solid rgba(255,255,255,.08); padding:12px; border-radius:12px; margin:.4rem 0}
    .hearts{display:flex; gap:6px; align-items:center}
    .heart{width:18px; height:18px; filter: drop-shadow(0 0 4px rgba(255,0,80,.25))}
    .meter{height:10px; background:rgba(255,255,255,.12); border-radius:999px; overflow:hidden}
    .meter>div{height:100%; width:0%; background:linear-gradient(90deg, #ff6b88, #ffd166, #3ddc97); transition: width .6s ease}
    .status{font-size:.95rem; color:var(--muted)}

    /* Center: Caldero y secuencia */
    .caldero{border:2px dashed rgba(255,255,255,.22); border-radius:16px; min-height:140px; padding:10px; display:flex; flex-wrap:wrap; gap:8px; align-content:flex-start; background: radial-gradient(250px 120px at 70% -30%, rgba(107,91,255,.2), transparent 40%), rgba(0,0,0,.15)}
    .drop-hint{font-size:.95rem; color:var(--muted)}
    .chip{user-select:none; display:inline-flex; align-items:center; gap:6px; background: rgba(255,255,255,.1); border:1px solid rgba(255,255,255,.22); padding:9px 12px; border-radius:999px; font-weight:600}
    .chip[draggable="true"]{cursor:grab}
    .chip.kid{font-size:1.05rem}
    .chip.bad{background: rgba(255,91,107,.15); border-color: rgba(255,91,107,.6)}
    .chip.good{background: rgba(61,220,151,.12); border-color: rgba(61,220,151,.5)}

    .actions{display:flex; gap:10px; margin-top:12px; flex-wrap:wrap}

    /* Right: Ingredientes */
    .ingredients{display:grid; grid-template-columns: 1fr; gap:8px}
    .ingredients .chip{background: rgba(255,255,255,.13)}
    .ingredients .chip:focus{outline:3px solid rgba(107,91,255,.65)}

    /* Progress */
    .progress{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .steps{display:flex; gap:6px}
    .dot{width:12px; height:12px; border-radius:50%; background:rgba(255,255,255,.18); border:1px solid rgba(255,255,255,.2)}
    .dot.done{background: linear-gradient(180deg, #3ddc97, #2bbd85)}
    .dot.current{box-shadow:0 0 0 3px rgba(107,91,255,.35)}

    /* Lexi modal */
    dialog{border:none; border-radius:18px; padding:0; background:rgba(22,24,54,.98); color:var(--text); width:min(900px, 92vw)}
    dialog::backdrop{background:rgba(0,0,20,.6)}
    .modal{padding:18px}
    .lexi{display:flex; gap:12px; align-items:center}
    .lexi .icon{width:72px; height:72px; border-radius:16px; background:linear-gradient(135deg, #ffd166, #ff9f1c); display:grid; place-items:center; font-size:36px}
    .cards{display:grid; grid-template-columns:repeat(auto-fit, minmax(180px,1fr)); gap:10px; margin:12px 0}
    .card{background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12); padding:12px; border-radius:14px}

    /* Confeti y efectos */
    .confetti{position:fixed; inset:0; pointer-events:none; overflow:hidden}
    .shard{position:absolute; width:10px; height:16px; transform:translate(-50%,-50%); animation: fall 1500ms linear forwards}
    @keyframes fall{to{transform:translate(var(--x, 0), 100vh) rotate(720deg)}}

    .shake{animation: shake .35s linear}
    @keyframes shake{10%,90%{transform:translateX(-1px)} 20%,80%{transform:translateX(2px)} 30%,50%,70%{transform:translateX(-3px)} 40%,60%{transform:translateX(3px)}}

    /* A11y helpers */
    .sr-only{position:absolute !important; height:1px; width:1px; overflow:hidden; clip: rect(1px, 1px, 1px, 1px); white-space:nowrap}

    /* Image placeholder (castillo) */
    .castle{width:100%; height:140px; border-radius:12px; background:linear-gradient(180deg,#b2ccff,#e6f0ff); display:grid; place-items:center; margin-top:6px}
    .castle svg{width:90%; height:100%}
  </style>
</head>
<body>
  <header class="row" role="banner">
    <h1 aria-label="El Laboratorio de las Palabras M√°gicas">
      üß™‚ú® El Laboratorio de las Palabras M√°gicas
      <span class="badge" aria-hidden="true">SPA ‚Ä¢ Offline ‚Ä¢ A11y</span>
    </h1>
    <div class="row" style="margin-left:auto">
      <button id="btnReglas" class="btn ghost" aria-haspopup="dialog" aria-controls="dlgReglas" title="Ver reglas">Reglas</button>
      <button id="btnLexi" class="btn secondary" aria-haspopup="dialog" aria-controls="dlgLexi" title="Hablar con Lexi">Volver con Lexi</button>
    </div>
  </header>

  <main id="layout" role="main" aria-live="polite">
    <!-- Panel Izquierdo: Personaje y Coraz√≥n -->
    <section id="leftPanel" class="panel" aria-labelledby="lblPersonaje">
      <h2 id="lblPersonaje">Foro Escolar</h2>
      <div class="avatar-wrap" id="avatarWrap">
        <div class="avatar" id="avatar" aria-hidden="true">üôÇ</div>
        <div>
          <div id="nombre" style="font-weight:800">‚Äî</div>
          <div class="status" id="tipoEsc">‚Äî</div>
        </div>
      </div>
      <div class="msg" id="mensajeOriginal" aria-live="polite">‚Äî</div>
      <div id="mediaEscenario" class="castle" aria-hidden="true" hidden></div>
      <div class="hearts" style="margin:8px 0">
        <span aria-hidden="true">‚ù§Ô∏è</span>
        <div class="meter" style="flex:1" aria-label="Medidor de coraz√≥n" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0"><div id="heartBar"></div></div>
        <span id="heartPct" class="status" style="min-width:36px; text-align:right">0%</span>
      </div>
      <div class="rule-list" aria-label="Reglas de convivencia" style="margin-top:6px">
        <div class="rule"><div class="emoji" aria-hidden="true">üå∑</div><div><strong>S√© Amable</strong><br/><small>Saluda y usa palabras bonitas.</small></div></div>
        <div class="rule"><div class="emoji" aria-hidden="true">üéì</div><div><strong>S√© Respetuoso</strong><br/><small>Critica ideas, no personas.</small></div></div>
        <div class="rule"><div class="emoji" aria-hidden="true">ü§ù</div><div><strong>S√© Buen Amigo</strong><br/><small>Valida emociones y ofrece ayuda.</small></div></div>
      </div>
    </section>

    <!-- Panel Central: Caldero -->
    <section id="centerPanel" class="panel" aria-labelledby="lblCaldero">
      <h2 id="lblCaldero">Caldero de Mensajes</h2>
      <div id="caldero" class="caldero" tabindex="0" role="list" aria-describedby="calderoHint" aria-dropeffect="copy">
        <div id="calderoHint" class="drop-hint">Arrastra o selecciona ingredientes para preparar tu mensaje aqu√≠‚Ä¶</div>
      </div>
      <div class="actions">
        <button id="btnEnviar" class="btn" title="Mezclar y enviar (Enter)">Mezclar / Enviar</button>
        <button id="btnDeshacer" class="btn secondary" title="Deshacer √∫ltimo ingrediente (Backspace)">Deshacer</button>
        <button id="btnRehacer" class="btn ghost" title="Limpiar caldero">Rehacer</button>
        <span class="status" id="feedback" aria-live="polite"></span>
      </div>
    </section>

    <!-- Panel Derecho: Ingredientes -->
    <aside id="rightPanel" class="panel" aria-labelledby="lblIngredientes">
      <h2 id="lblIngredientes">Ingredientes de Palabras</h2>
      <div class="ingredients" id="ingredients" role="listbox" aria-label="Lista de ingredientes seleccionables"></div>
    </aside>
  </main>

  <footer class="row" role="contentinfo">
    <div class="progress" aria-label="Progreso">
      <span id="progressLabel">Escenario 1 de 5</span>
      <div class="steps" aria-hidden="true" id="steps"></div>
    </div>
    <div style="margin-left:auto" class="row">
      <button id="prevBtn" class="btn secondary" aria-label="Anterior">‚üµ</button>
      <button id="nextBtn" class="btn secondary" aria-label="Siguiente">‚ü∂</button>
    </div>
  </footer>

  <!-- Modal: Reglas -->
  <dialog id="dlgReglas" aria-labelledby="dlgReglasTitle">
    <div class="modal">
      <div class="row" style="justify-content:space-between; align-items:center">
        <h3 id="dlgReglasTitle" style="margin:.4rem 0">Reglas del Laboratorio</h3>
        <button class="btn ghost" onclick="this.closest('dialog').close()" aria-label="Cerrar">Cerrar</button>
      </div>
      <div class="cards">
        <div class="card"><strong>üå∑ S√© Amable</strong><br/>Saluda y usa palabras bonitas.</div>
        <div class="card"><strong>üéì S√© Respetuoso</strong><br/>Critica ideas, no personas.</div>
        <div class="card"><strong>ü§ù S√© Buen Amigo</strong><br/>Valida emociones y ofrece ayuda.</div>
      </div>
      <p><strong>Atajos:</strong> <kbd>Enter</kbd> enviar ‚Ä¢ <kbd>Backspace</kbd> deshacer ‚Ä¢ Navega con <kbd>Tab</kbd> y pulsa <kbd>Enter</kbd> para a√±adir.</p>
    </div>
  </dialog>

  <!-- Modal: Lexi (briefing / entrenamiento) -->
  <dialog id="dlgLexi" aria-labelledby="dlgLexiTitle">
    <div class="modal">
      <div class="lexi">
        <div class="icon" role="img" aria-label="Lexi, libro m√°gico parlante">üìñ‚ú®</div>
        <div>
          <h3 id="dlgLexiTitle" style="margin:.2rem 0">¬°Hola, Mensajero del Coraz√≥n!</h3>
          <p id="lexiSpeech">Soy <strong>Lexi</strong>. Cada palabra es un <em>hechizo</em>. Mira esta mini demo:</p>
        </div>
      </div>
      <div class="row" style="margin-top:8px; gap:12px; flex-wrap:wrap">
        <button class="btn" id="demoHola">Enviar ‚Äú¬°Hola!‚Äù</button>
        <button class="btn" id="demoTonto" style="background:var(--danger)">Enviar ‚ÄúTonto‚Äù</button>
      </div>
      <div class="cards">
        <div class="card">‚ù§Ô∏è <strong>Sube</strong> con palabras amables.</div>
        <div class="card">üß† <strong>Respeta</strong> ideas, no ataques personas.</div>
        <div class="card">ü§ù <strong>Valida</strong> emociones y ofrece ayuda.</div>
      </div>
      <div class="row" style="justify-content:flex-end">
        <button class="btn secondary" onclick="document.getElementById('dlgLexi').close()">Ir al Foro</button>
      </div>
    </div>
  </dialog>

  <!-- Confeti -->
  <div class="confetti" id="confetti" aria-hidden="true"></div>

  <script>
  // ==========================
  // Datos del juego (5 escenarios)
  // ==========================
  const escenarios = [
    {
      id: 1,
      nombre: "El Amigo Triste",
      personaje: "Ana",
      avatar: "üòä",
      mensajeOriginal: "Estoy triste, mi perro se enferm√≥.",
      ingredientes: ["Lo siento mucho,", "¬°√Ånimo!", "Ana,", "No es para tanto,", "Espero que se mejore."],
      solucion: ["Lo siento mucho,", "Ana,", "Espero que se mejore.", "¬°√Ånimo!"],
      tipo: "consuelo",
      hints: ["Empieza validando el sentimiento.", "Incluye el nombre para hacerlo cercano.", "Termina con √°nimo positivo."],
    },
    {
      id: 2,
      nombre: "El Desacuerdo Respetuoso",
      personaje: "Leo",
      avatar: "üßë‚ÄçüöÄ",
      mensajeOriginal: "¬°El mejor superh√©roe es Capit√°n Cometa! ¬°No hay discusi√≥n!",
      ingredientes: ["Est√°s equivocado,", "Respeto tu opini√≥n,", "Capit√°n Cometa es aburrido,", "pero a m√≠ me gusta m√°s Dra. Estrella.", "porque es m√°s inteligente."],
      solucion: ["Respeto tu opini√≥n,", "pero a m√≠ me gusta m√°s Dra. Estrella.", "porque es m√°s inteligente."],
      tipo: "desacuerdo",
      hints: ["Empieza mostrando respeto.", "Expresa tu preferencia sin atacar.", "Da una raz√≥n amable."],
    },
    {
      id: 3,
      nombre: "La Felicitaci√≥n",
      personaje: "Sara",
      avatar: "üëë",
      mensajeOriginal: "¬°Miren el castillo de bloques que constru√≠!",
      media: "castle",
      ingredientes: ["El m√≠o es mejor.", "¬°Wow, Sara!", "¬°Qu√© incre√≠ble!", "Te qued√≥ genial."],
      solucion: ["¬°Wow, Sara!", "¬°Qu√© incre√≠ble!", "Te qued√≥ genial."],
      tipo: "elogio",
      hints: ["Comienza con entusiasmo.", "Refuerza lo positivo.", "Evita compararte."],
    },
    {
      id: 4,
      nombre: "Malentendido en el Juego",
      personaje: "Marco",
      avatar: "‚öΩ",
      mensajeOriginal: "¬°Perdimos por tu culpa! ¬°No me pasaste la pelota a tiempo!",
      ingredientes: ["No es mi culpa,", "T√∫ eres el malo,", "Entiendo que est√©s frustrado,", "pero todos somos un equipo.", "la pr√≥xima vez lo haremos mejor.", "¬°C√°lmate!"],
      solucion: ["Entiendo que est√©s frustrado,", "pero todos somos un equipo.", "la pr√≥xima vez lo haremos mejor."],
      tipo: "conflicto",
      hints: ["Valida la emoci√≥n.", "Recuerda el trabajo en equipo.", "Ofrece mejora futura."],
    },
    {
      id: 5,
      nombre: "La Pregunta Confusa",
      personaje: "Luc√≠a",
      avatar: "‚ùì",
      mensajeOriginal: "No entend√≠ nada de la tarea, ¬øalguien me ayuda? Me siento tonta.",
      ingredientes: ["Es muy f√°cil,", "No te preocupes,", "a m√≠ tambi√©n me cost√≥ al principio.", "¬øQuieres que lo repasemos juntos por videollamada?", "Lee otra vez.", "Luc√≠a,"],
      solucion: ["No te preocupes,", "Luc√≠a,", "a m√≠ tambi√©n me cost√≥ al principio.", "¬øQuieres que lo repasemos juntos por videollamada?"],
      tipo: "ayuda",
      hints: ["Tranquiliza primero.", "Personaliza con su nombre.", "Comparte empat√≠a.", "Ofrece ayuda concreta."],
    },
  ];

  // Ingredientes da√±inos (error severo)
  const ingredientesPeligrosos = new Set([
    "No es para tanto,",
    "Est√°s equivocado,",
    "Capit√°n Cometa es aburrido,",
    "T√∫ eres el malo,",
    "¬°C√°lmate!",
    "El m√≠o es mejor.",
    "Es muy f√°cil,",
    "Lee otra vez."
  ]);

  // Estado del juego
  let indice = 0; // escenario actual
  let seleccionActual = []; // ingredientes en el caldero
  const progreso = new Map(); // id -> {exito:boolean, corazon:number}
  let amabilidadTotal = 0; // 0‚Äì100

  // Referencias UI
  const ingredientsEl = document.getElementById('ingredients');
  const calderoEl = document.getElementById('caldero');
  const feedbackEl = document.getElementById('feedback');
  const heartBar = document.getElementById('heartBar');
  const heartPct = document.getElementById('heartPct');
  const confettiEl = document.getElementById('confetti');

  // ==========================
  // Render de escenario
  // ==========================
  /**
   * renderEscenario(): Dibuja la UI del escenario actual (avatar, mensaje, ingredientes, medidor, progreso).
   */
  function renderEscenario(){
    const e = escenarios[indice];
    document.getElementById('nombre').textContent = e.personaje + ' ‚Äî ' + e.nombre;
    document.getElementById('tipoEsc').textContent = 'Tema: ' + e.tipo;
    document.getElementById('mensajeOriginal').textContent = '"' + e.mensajeOriginal + '"';
    document.getElementById('avatar').textContent = e.avatar || 'üôÇ';

    // Media (castillo) solo para Sara
    const media = document.getElementById('mediaEscenario');
    media.hidden = true; media.innerHTML = '';
    if(e.media === 'castle'){
      media.hidden = false;
      media.setAttribute('role','img');
      media.setAttribute('aria-label','Castillo de bloques construido por Sara');
      media.innerHTML = castleSVG();
    }

    // Ingredientes
    ingredientsEl.innerHTML = '';
    e.ingredientes.forEach((txt, i)=>{
      const btn = document.createElement('button');
      btn.className = 'chip kid';
      btn.setAttribute('role','option');
      btn.setAttribute('aria-selected','false');
      btn.textContent = txt;
      btn.draggable = true;
      btn.dataset.index = i;
      btn.addEventListener('click', ()=> a√±adirIngrediente(txt));
      btn.addEventListener('dragstart', dragStart);
      ingredientsEl.appendChild(btn);
    });

    // Caldero
    seleccionActual = [];
    calderoEl.innerHTML = '<div id="calderoHint" class="drop-hint">Arrastra o selecciona ingredientes para preparar tu mensaje aqu√≠‚Ä¶</div>';
    calderoEl.addEventListener('dragover', ev=> ev.preventDefault());
    calderoEl.addEventListener('drop', (ev)=>{
      ev.preventDefault();
      const data = ev.dataTransfer.getData('text/plain');
      if(data) a√±adirIngrediente(data);
    });

    // Progreso visual
    document.getElementById('progressLabel').textContent = `Escenario ${indice+1} de ${escenarios.length}`;
    const steps = document.getElementById('steps');
    steps.innerHTML = '';
    for(let i=0; i<escenarios.length; i++){
      const dot = document.createElement('div');
      dot.className = 'dot' + (i===indice? ' current':'') + (progreso.get(escenarios[i].id)?.exito? ' done':'');
      steps.appendChild(dot);
    }

    // Medidor
    const estado = progreso.get(e.id) || {corazon: 40, exito:false};
    actualizarCorazon(estado.corazon);

    // Botones nav
    document.getElementById('prevBtn').disabled = indice===0;
    document.getElementById('nextBtn').disabled = indice===escenarios.length-1;

    feedback('Elige ingredientes y ord√©nalos. Pista: ' + e.hints[0]);
  }

  // ==========================
  // L√≥gica de interacci√≥n
  // ==========================
  /** a√±adirIngrediente(txt): agrega una pieza al caldero y la representa. */
  function a√±adirIngrediente(txt){
    if(seleccionActual.length===0) calderoEl.innerHTML = '';
    seleccionActual.push(txt);
    const chip = document.createElement('span');
    chip.className = 'chip ' + (ingredientesPeligrosos.has(txt)? 'bad':'good');
    chip.textContent = txt;
    chip.setAttribute('role','listitem');
    chip.draggable = true;
    chip.addEventListener('dragstart', (ev)=>{
      ev.dataTransfer.setData('text/plain', txt);
      setTimeout(()=> chip.remove(), 0); // mover entre caldero y bandeja
    });
    calderoEl.appendChild(chip);
    feedback('A√±adido al caldero. Ingredientes: ' + seleccionActual.length);
  }

  /** deshacer(): elimina el √∫ltimo ingrediente del caldero. */
  function deshacer(){
    if(!seleccionActual.length) return;
    seleccionActual.pop();
    const nodes = [...calderoEl.querySelectorAll('.chip')];
    nodes[nodes.length-1]?.remove();
    if(!calderoEl.querySelector('.chip')) calderoEl.innerHTML = '<div id="calderoHint" class="drop-hint">Arrastra o selecciona ingredientes para preparar tu mensaje aqu√≠‚Ä¶</div>';
  }

  /** enviarMensaje(): valida y aplica efectos. */
  function enviarMensaje(){
    const e = escenarios[indice];
    const res = evaluarMensaje(seleccionActual, e);
    aplicarFeedback(res, e);
  }

  /**
   * evaluarMensaje(): compara seleccionActual vs soluci√≥n del escenario.
   * - Coincide exactamente y en orden => exito true
   * - Contiene ingredientes peligrosos => severo true
   * - Si no, devuelve pistas (neutral)
   */
  function evaluarMensaje(sel, esc){
    const tienePeligrosos = sel.some(s => ingredientesPeligrosos.has(s));
    const esIgual = sel.length === esc.solucion.length && sel.every((s,i)=> s===esc.solucion[i]);

    if(tienePeligrosos) return {tipo:'severo'};
    if(esIgual) return {tipo:'exito'};

    // Pistas: evaluar primeros elementos
    const pistas = [];
    if(!sel.length){
      pistas.push(esc.hints[0]);
    } else {
      if(sel[0] !== esc.solucion[0]) pistas.push(esc.hints[0]);
      if(!sel.some(x=> x.includes(esc.personaje)) && esc.solucion.some(x=> x.includes(esc.personaje))) pistas.push('Incluye el nombre para hacerlo cercano.');
      if(sel.length < esc.solucion.length) pistas.push('A√∫n faltan ingredientes.');
    }
    return {tipo:'neutral', pistas};
  }

  /** aplicarFeedback(): actualiza corazones, sonidos, voz y confeti seg√∫n resultado. */
  function aplicarFeedback(resultado, esc){
    let estado = progreso.get(esc.id) || {corazon:40, exito:false};
    switch(resultado.tipo){
      case 'exito':
        reproducirMagia();
        hablar("¬°Hechizo de amabilidad lanzado! ¬°Has hecho sentir bien a tu amigo!");
        estado.corazon = Math.min(100, estado.corazon + 30);
        amabilidadTotal = Math.min(100, amabilidadTotal + 20);
        actualizarCorazon(estado.corazon);
        progreso.set(esc.id, {corazon: estado.corazon, exito:true});
        feedback('¬°Perfecto! Mensaje respetuoso y emp√°tico.');
        if(esc.id===1 || esc.id===3 || esc.id===5) lanzarConfeti();
        // condici√≥n de victoria
        const exitos = [...progreso.values()].filter(p=>p.exito).length;
        if(exitos>=5 || exitos>=3){
          mostrarVictoria(exitos);
        }
        break;
      case 'severo':
        reproducirCristal();
        hablar("¬°Cuidado! Esas palabras atacaron a tu amigo, no a su idea. ¬°Su coraz√≥n se ha da√±ado!");
        estado.corazon = Math.max(0, estado.corazon - 25);
        actualizarCorazon(estado.corazon);
        sacudir(document.getElementById('leftPanel'));
        progreso.set(esc.id, {corazon: estado.corazon, exito:false});
        document.body.dataset.fallo = '1';
        mostrarDerrotaParcial();
        feedback('Mensaje da√±ino: revisa las reglas y reintenta.');
        break;
      default:
        reproducirEquilibrio();
        feedback('Casi. ' + (resultado.pistas?.join(' ') || 'Ordena mejor los ingredientes.'));
        hablar("Excelente intento. Se puede estar en desacuerdo sin dejar de ser amigos.");
        break;
    }
  }

  /** actualizarCorazon(val): anima el medidor y texto. */
  function actualizarCorazon(val){
    heartBar.style.width = Math.round(val) + '%';
    heartPct.textContent = Math.round(val) + '%';
    heartBar.parentElement.setAttribute('aria-valuenow', Math.round(val));
  }

  // ==========================
  // Utilidades de UI / FX
  // ==========================
  function feedback(msg){ feedbackEl.textContent = msg; }
  function sacudir(el){ el.classList.add('shake'); setTimeout(()=> el.classList.remove('shake'), 380); }

  function lanzarConfeti(){
    for(let i=0;i<60;i++){
      const s = document.createElement('div');
      s.className='shard';
      s.style.left = Math.random()*100 + 'vw';
      s.style.top = '-10vh';
      s.style.setProperty('--x', (Math.random()*60-30) + 'vw');
      s.style.background = `hsl(${Math.random()*360}, 90%, 60%)`;
      s.style.borderRadius = Math.random()>.5? '4px' : '999px';
      confettiEl.appendChild(s);
      setTimeout(()=> s.remove(), 1600);
    }
  }

  // Sonidos (WebAudio): magia, equilibrio, cristal roto
  let audioCtx=null;
  function ensureAudio(){ if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)(); }
  function beep(freq, dur, type='sine', vol=.2){
    ensureAudio();
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = type; o.frequency.value = freq; o.connect(g); g.connect(audioCtx.destination);
    g.gain.value = vol; o.start(); setTimeout(()=>{o.stop();}, dur);
  }
  function reproducirMagia(){ beep(880,140,'triangle',.15); setTimeout(()=>beep(1320,170,'triangle',.15),120); setTimeout(()=>beep(1760,180,'triangle',.12),260); }
  function reproducirEquilibrio(){ beep(660,120,'sine',.12); setTimeout(()=>beep(550,120,'sine',.12),120); }
  function reproducirCristal(){ for(let i=0;i<6;i++) setTimeout(()=>beep(2200- i*120,90,'sawtooth',.08), i*50); }

  // Voz (Web Speech API)
  function hablar(text){
    if(!('speechSynthesis' in window)) return;
    const u = new SpeechSynthesisUtterance(text);
    u.lang = 'es-MX';
    u.rate = 1.02; u.pitch = 1.1; u.volume = 1;
    speechSynthesis.cancel();
    speechSynthesis.speak(u);
  }

  // Drag helpers
  function dragStart(ev){ ev.dataTransfer.setData('text/plain', ev.target.textContent); }

  // ==========================
  // Navegaci√≥n entre escenarios
  // ==========================
  document.getElementById('prevBtn').addEventListener('click', ()=>{ indice=Math.max(0, indice-1); renderEscenario(); });
  document.getElementById('nextBtn').addEventListener('click', ()=>{ indice=Math.min(escenarios.length-1, indice+1); renderEscenario(); });
  document.getElementById('btnDeshacer').addEventListener('click', deshacer);
  document.getElementById('btnRehacer').addEventListener('click', ()=>{ seleccionActual=[]; calderoEl.innerHTML = '<div id="calderoHint" class="drop-hint">Arrastra o selecciona ingredientes para preparar tu mensaje aqu√≠‚Ä¶</div>'; feedback('Caldero limpio.'); });
  document.getElementById('btnEnviar').addEventListener('click', enviarMensaje);
  document.getElementById('btnReglas').addEventListener('click', ()=> document.getElementById('dlgReglas').showModal());
  document.getElementById('btnLexi').addEventListener('click', ()=> document.getElementById('dlgLexi').showModal());

  // Demo de Lexi
  document.getElementById('demoHola').addEventListener('click', ()=>{ actualizarCorazon(100); reproducirMagia(); hablar('¬°Hechizo de amabilidad lanzado! ¬°Has hecho sentir bien a tu amigo!'); });
  document.getElementById('demoTonto').addEventListener('click', ()=>{ actualizarCorazon(15); reproducirCristal(); hablar('¬°Cuidado! Esas palabras atacaron a tu amigo.'); });

  // Teclado: Enter = enviar, Backspace = deshacer
  document.addEventListener('keydown', (ev)=>{
    if(ev.key==='Enter' && !ev.shiftKey){ ev.preventDefault(); enviarMensaje(); }
    if(ev.key==='Backspace'){ if(document.activeElement === document.body || document.activeElement.closest('#layout')){ ev.preventDefault(); deshacer(); } }
  });

  // ==========================
  // Pantallas finales
  // ==========================
  function mostrarVictoria(exitos){
    // Evita m√∫ltiples pantallas si se sigue jugando
    if(document.getElementById('dlgWin')) return;
    lanzarConfeti(); lanzarConfeti();
    hablar('¬°Con palabras de respeto y de valor, construyo amistad y un mundo mejor!');
    const dlg = document.createElement('dialog');
    dlg.id='dlgWin'; dlg.innerHTML = `<div class="modal">\
      <h3>¬°Misi√≥n Cumplida, Mensajero!</h3>\
      <p>Hoy consolaste a 1 amigo, expresaste 1 desacuerdo con respeto y felicitaste a 1 compa√±era. Has llenado el Foro con ${Math.max(amabilidadTotal, 100)} puntos de amabilidad.</p>\
      <blockquote>‚Äú<strong>¬°Con palabras de respeto y de valor, construyo amistad y un mundo mejor!</strong>‚Äù</blockquote>\
      <div class="row" style="justify-content:flex-end">\
        <button class="btn secondary" onclick="this.closest('dialog').close()">Seguir jugando</button>\
      </div>\
    </div>`;
    document.body.appendChild(dlg); dlg.showModal();
  }
  function mostrarDerrotaParcial(){
    const dlg = document.getElementById('dlgFail') || document.createElement('dialog');
    dlg.id='dlgFail';
    dlg.innerHTML = `<div class="modal">\
      <h3>Foro en gris‚Ä¶</h3>\
      <p>Lexi dice: ‚ÄúVolvamos al laboratorio y repasemos las recetas de la amabilidad.‚Äù</p>\
      <div class="row" style="justify-content:flex-end">\
        <button class="btn" onclick="this.closest('dialog').close()">Reintentar escenario</button>\
      </div>\
    </div>`;
    document.body.appendChild(dlg); dlg.showModal();
    setTimeout(()=>{ document.body.dataset.fallo=''; }, 600);
  }

  // ==========================
  // SVG Castillo local (sin red)
  // ==========================
  function castleSVG(){
    return `<svg viewBox="0 0 200 120" role="img" aria-label="Castillo de bloques">\
      <rect x="10" y="80" width="180" height="30" fill="#8ecae6" rx="6"/>\
      <rect x="25" y="60" width="40" height="20" fill="#219ebc" rx="4"/>\
      <rect x="65" y="50" width="40" height="30" fill="#ffb703" rx="4"/>\
      <rect x="105" y="60" width="40" height="20" fill="#fb8500" rx="4"/>\
      <rect x="145" y="40" width="30" height="40" fill="#90be6d" rx="4"/>\
      <polygon points="45,40 65,50 25,50" fill="#ffb703"/>\
      <polygon points="85,35 105,50 65,50" fill="#fb8500"/>\
      <polygon points="160,25 175,40 145,40" fill="#90be6d"/>\
    </svg>`;
  }

  // ==========================
  // Inicializar
  // ==========================
  renderEscenario();
  // Abrir briefing al inicio
  setTimeout(()=> document.getElementById('dlgLexi').showModal(), 200);

  // ==========================
  // Service Worker inline (offline)
  // ==========================
  if('serviceWorker' in navigator){
    const swCode = `const CACHE='lab-palabras-magicas-v1';\nself.addEventListener('install',e=>{e.waitUntil(caches.open(CACHE).then(c=>c.addAll(['./'])))});\nself.addEventListener('activate',e=>{e.waitUntil(self.clients.claim())});\nself.addEventListener('fetch',e=>{e.respondWith(caches.match(e.request).then(r=> r || fetch(e.request).then(resp=>{const copy=resp.clone(); caches.open(CACHE).then(c=>c.put(e.request, copy)); return resp;}).catch(()=>caches.match('./'))))});`;
    const blob = new Blob([swCode], {type:'application/javascript'});
    const url = URL.createObjectURL(blob);
    navigator.serviceWorker.register(url).catch(()=>{});
  }

  // ==========================
  // Comentarios de funciones principales (para referencia de desarrollo)
  // renderEscenario(): Dibuja el escenario y resetea UI.
  // a√±adirIngrediente(): Agrega ingrediente al caldero y renderiza chip.
  // deshacer(): Quita el √∫ltimo chip del caldero.
  // enviarMensaje(): Dispara evaluaci√≥n y feedback.
  // evaluarMensaje(): Compara selecci√≥n con soluci√≥n y detecta peligrosos.
  // aplicarFeedback(): Sonidos, voz, confeti, cambios en corazones/estado.
  // actualizarCorazon(): Anima barra de coraz√≥n y ARIA.
  // ==========================
  </script>
</body>
</html>
