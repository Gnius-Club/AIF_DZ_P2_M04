<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>El Laboratorio de las Palabras M√°gicas</title>
    <meta name="description" content="Un juego para aprender a ser respetuoso y amable en los chats escolares.">
    
    <style>
        /* --- ESTILOS GENERALES Y FUENTES --- */
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap');

        :root {
            --bg-color: #f0f4f8;
            --main-bg: #ffffff;
            --primary-color: #4a47a3;
            --secondary-color: #706fd3;
            --accent-color: #f6b93b;
            --text-color: #333;
            --success-color: #4caf50;
            --error-color: #f44336;
            --neutral-color: #2196f3;
            --heart-color: #ff4757;
            --font-family: 'Poppins', sans-serif;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html, body {
            height: 100%;
            font-family: var(--font-family);
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
        }

        /* --- CONTENEDOR PRINCIPAL Y PANTALLAS --- */
        #game-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            flex-grow: 1;
            padding: 20px;
            background: var(--main-bg);
            border-radius: 20px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }

        .hidden { display: none !important; }

        /* --- PANTALLA DE INTRODUCCI√ìN --- */
        #intro-screen h1 {
            color: var(--primary-color);
            font-size: 2.5rem;
            margin-bottom: 1rem;
        }
        #intro-screen p {
            max-width: 600px;
            margin-bottom: 1.5rem;
        }
        .lexi-avatar {
            font-size: 5rem;
            margin-bottom: 1rem;
            animation: float 3s ease-in-out infinite;
        }
        .rules-preview {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }
        .rule-card {
            background-color: #eef2f7;
            border: 2px solid var(--secondary-color);
            border-radius: 10px;
            padding: 15px;
            width: 150px;
        }
        .rule-card h3 { color: var(--primary-color); }

        /* --- PANTALLA DE JUEGO PRINCIPAL --- */
        #game-screen {
            display: grid;
            grid-template-areas:
                "header header"
                "character crafting"
                "ingredients ingredients"
                "footer footer";
            grid-template-rows: auto 1fr auto auto;
            grid-template-columns: 1fr 1.5fr;
            gap: 20px;
            padding: 20px;
            height: 100%;
        }

        header { grid-area: header; text-align: center; }
        #character-panel { grid-area: character; }
        #crafting-panel { grid-area: crafting; }
        #ingredients-panel { grid-area: ingredients; }
        footer { grid-area: footer; }
        
        /* --- ESTILOS DE PANELES --- */
        .panel {
            background: #fdfdff;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        /* Personaje */
        #character-panel { align-items: center; text-align: center; }
        #character-avatar {
            width: 100px;
            height: 100px;
            background: var(--secondary-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            color: white;
            margin-bottom: 10px;
        }
        #character-name { font-size: 1.5rem; font-weight: bold; color: var(--primary-color); }
        #original-message {
            background: #eef2f7;
            padding: 10px;
            border-radius: 10px;
            width: 100%;
            font-style: italic;
        }
        
        /* Medidor de Coraz√≥n */
        #heart-meter { display: flex; gap: 5px; font-size: 2rem; }
        .heart { 
            color: #ddd;
            transition: color 0.3s, transform 0.3s;
        }
        .heart.full { color: var(--heart-color); }
        .heart.cracked {
            color: var(--heart-color);
            animation: shake 0.5s;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px) rotate(-3deg); }
            75% { transform: translateX(5px) rotate(3deg); }
        }
        @keyframes heart-beat {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }

        /* Caldero y Controles */
        #crafting-panel h2 { color: var(--primary-color); }
        #cauldron {
            min-height: 120px;
            background: #eef2f7;
            border: 2px dashed var(--secondary-color);
            border-radius: 10px;
            padding: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-content: flex-start;
        }
        .cauldron-word {
            background: var(--accent-color);
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-weight: 600;
            cursor: grab;
            transition: opacity 0.3s;
        }
        .cauldron-word.dragging {
            opacity: 0.5;
        }
        #crafting-controls {
            display: flex;
            gap: 10px;
            margin-top: auto;
        }

        /* Ingredientes */
        #ingredients-panel h2 { color: var(--primary-color); }
        #ingredients-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
        }
        .ingredient {
            background: var(--main-bg);
            border: 2px solid var(--secondary-color);
            color: var(--secondary-color);
            padding: 10px 15px;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: 600;
            cursor: grab;
            transition: background-color 0.2s, color 0.2s, transform 0.2s;
        }
        .ingredient:hover, .ingredient:focus {
            background: var(--secondary-color);
            color: white;
            transform: translateY(-2px);
        }
        .ingredient:active { cursor: grabbing; }
        .ingredient.disabled {
            background: #ccc;
            border-color: #aaa;
            color: #888;
            cursor: not-allowed;
            opacity: 0.6;
        }

        /* Footer */
        footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 10px;
            border-top: 1px solid #ddd;
        }
        #progress-indicator { font-weight: bold; }

        /* --- BOTONES --- */
        .btn {
            border: none;
            border-radius: 25px;
            padding: 12px 25px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            font-family: var(--font-family);
        }
        .btn-primary {
            background: var(--accent-color);
            color: white;
            box-shadow: 0 4px var(--primary-color);
        }
        .btn-primary:hover { background: #f9c74f; }
        .btn-primary:active {
            box-shadow: none;
            transform: translateY(4px);
        }
        .btn-secondary {
            background: #eee;
            color: var(--primary-color);
        }
        #send-btn { background-color: var(--success-color); color: white; flex-grow: 1; }
        #reset-btn { background-color: var(--error-color); color: white; flex-grow: 1; }

        /* --- PANTALLAS FINALES --- */
        #win-screen h1, #lose-screen h1 { font-size: 3rem; margin-bottom: 20px; }
        #win-screen {
            background: linear-gradient(45deg, #a8e063, #56ab2f);
            color: white;
        }
        #win-screen .final-quote { font-style: italic; font-size: 1.3rem; margin-top: 20px; max-width: 500px; }
        #lose-screen {
            background: #718093;
            color: white;
        }
        @keyframes confetti-fall {
            0% { transform: translateY(-100vh) rotate(0); }
            100% { transform: translateY(100vh) rotate(720deg); }
        }
        .confetti {
            position: fixed;
            width: 10px;
            height: 20px;
            background-color: var(--accent-color);
            top: -50px;
            opacity: 0.8;
            animation: confetti-fall 5s linear infinite;
        }

        /* --- MODAL DE REGLAS Y FEEDBACK --- */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal-content {
            background: var(--main-bg);
            padding: 30px;
            border-radius: 20px;
            max-width: 500px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            position: relative;
        }
        .modal-content h2 { color: var(--primary-color); margin-bottom: 15px; }
        .close-btn {
            position: absolute;
            top: 15px; right: 15px;
            background: none; border: none;
            font-size: 1.5rem; cursor: pointer;
        }
        
        #feedback-modal .modal-content {
            border-top: 10px solid;
        }
        #feedback-modal.success .modal-content { border-color: var(--success-color); }
        #feedback-modal.error .modal-content { border-color: var(--error-color); }
        #feedback-modal.neutral .modal-content { border-color: var(--neutral-color); }
        #feedback-icon { font-size: 4rem; margin-bottom: 1rem; }
        #feedback-lexi-voice { font-style: italic; color: #555; margin-top: 10px; }
        
        /* --- ACCESIBILIDAD Y ANIMACIONES --- */
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-15px); }
        }

        /* --- RESPONSIVIDAD --- */
        @media (max-width: 768px) {
            #game-container { padding: 10px; }
            #game-screen {
                grid-template-areas:
                    "header"
                    "character"
                    "crafting"
                    "ingredients"
                    "footer";
                grid-template-columns: 1fr;
                grid-template-rows: auto;
                height: auto;
            }
            .panel { padding: 15px; }
            h1 { font-size: 2rem; }
            .btn { font-size: 1rem; padding: 10px 20px; }
            #cauldron { min-height: 80px; }
        }

    </style>
</head>
<body>

    <div id="game-container" role="main">

        <!-- ===== PANTALLA DE INTRODUCCI√ìN ===== -->
        <div id="intro-screen" class="screen">
            <div class="lexi-avatar" aria-hidden="true">üìñ</div>
            <h1>El Laboratorio de las Palabras M√°gicas</h1>
            <p>¬°Hola, Mensajero del Coraz√≥n! Soy Lexi, tu libro m√°gico. En el Foro Escolar, ¬°cada palabra es un hechizo! Algunas palabras alegran los corazones ‚ù§Ô∏è, pero otras pueden da√±arlos üíî. Tu misi√≥n es crear mensajes que cuiden a tus amigos.</p>
            <div class="rules-preview">
                <div class="rule-card"><h3>S√© Amable</h3><p>Usa saludos y palabras bonitas.</p></div>
                <div class="rule-card"><h3>S√© Respetuoso</h3><p>Critica ideas, no a las personas.</p></div>
                <div class="rule-card"><h3>S√© Buen Amigo</h3><p>Ayuda y apoya a los dem√°s.</p></div>
            </div>
            <br>
            <button id="start-game-btn" class="btn btn-primary">¬°Ir al Foro!</button>
        </div>

        <!-- ===== PANTALLA DE JUEGO ===== -->
        <div id="game-screen" class="screen hidden">
            <header>
                <h1 id="scenario-title">Desaf√≠o 1</h1>
            </header>

            <div id="character-panel" class="panel">
                <div id="character-avatar" aria-hidden="true"></div>
                <h2 id="character-name"></h2>
                <div id="heart-meter" role="img" aria-label="Medidor de Coraz√≥n"></div>
                <p id="original-message"></p>
            </div>

            <div id="crafting-panel" class="panel">
                <h2>Caldero de Mensajes</h2>
                <div id="cauldron" role="log" aria-live="polite" aria-label="Mensaje que est√°s construyendo"></div>
                <div id="crafting-controls">
                    <button id="send-btn" class="btn">Mezclar y Enviar</button>
                    <button id="reset-btn" class="btn">Rehacer</button>
                </div>
            </div>

            <div id="ingredients-panel" class="panel">
                <h2>Ingredientes de Palabras</h2>
                <div id="ingredients-container"></div>
            </div>

            <footer>
                <span id="progress-indicator" aria-live="polite">Escenario 1 de 5</span>
                <button id="rules-btn" class="btn btn-secondary">Ver Reglas</button>
            </footer>
        </div>

        <!-- ===== PANTALLA DE VICTORIA ===== -->
        <div id="win-screen" class="screen hidden">
            <div id="confetti-container"></div>
            <h1>¬°Misi√≥n Cumplida, Maestro Mensajero!</h1>
            <p id="win-stats"></p>
            <p class="final-quote">"¬°Con palabras de respeto y de valor, construyo amistad y un mundo mejor!"</p>
            <br>
            <button id="play-again-btn" class="btn btn-primary">Jugar de Nuevo</button>
        </div>

        <!-- ===== MODAL DE REGLAS ===== -->
        <div id="rules-modal" class="modal-overlay hidden" role="dialog" aria-modal="true" aria-labelledby="rules-title">
            <div class="modal-content">
                <button class="close-btn" aria-label="Cerrar">&times;</button>
                <h2 id="rules-title">Las 3 Reglas del Chat</h2>
                <ul>
                    <li><strong>S√© Amable:</strong> Siempre saluda y usa palabras bonitas como "por favor" y "gracias".</li>
                    <li><strong>S√© Respetuoso:</strong> Si no est√°s de acuerdo con algo, explica por qu√© sin insultar a la otra persona. ¬°Ataca la idea, no a la persona!</li>
                    <li><strong>S√© Buen Amigo:</strong> Si ves que alguien est√° triste o confundido, ofr√©cele tu ayuda y an√≠male. ¬°Validar sus sentimientos es muy importante!</li>
                </ul>
            </div>
        </div>

        <!-- ===== MODAL DE FEEDBACK ===== -->
        <div id="feedback-modal" class="modal-overlay hidden" role="alertdialog" aria-modal="true" aria-labelledby="feedback-title">
            <div class="modal-content">
                <div id="feedback-icon" aria-hidden="true"></div>
                <h2 id="feedback-title"></h2>
                <p id="feedback-text"></p>
                <p id="feedback-lexi-voice"></p>
                <br>
                <button class="btn btn-primary close-feedback-btn">Entendido</button>
            </div>
        </div>

    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {

        // --- DATOS DEL JUEGO ---
        const scenarios = [
            { id: 1, nombre: "El Amigo Triste", personaje: "Ana", avatar: "üò¢", mensajeOriginal: "Estoy triste, mi perro se enferm√≥.", ingredientes: ["Lo siento mucho,", "¬°√Ånimo!", "Ana,", "No es para tanto,", "Espero que se mejore."], solucion: ["Lo siento mucho,", "Ana,", "Espero que se mejore.", "¬°√Ånimo!"], palabrasDaninas: ["No es para tanto,"], corazonesIniciales: 2, tipo: "consuelo" },
            { id: 2, nombre: "El Desacuerdo Respetuoso", personaje: "Leo", avatar: "ü§î", mensajeOriginal: "¬°El mejor superh√©roe es Capit√°n Cometa! ¬°No hay discusi√≥n!", ingredientes: ["Est√°s equivocado,", "Respeto tu opini√≥n,", "Capit√°n Cometa es aburrido,", "pero a m√≠ me gusta m√°s Dra. Estrella.", "porque es m√°s inteligente."], solucion: ["Respeto tu opini√≥n,", "pero a m√≠ me gusta m√°s Dra. Estrella.", "porque es m√°s inteligente."], palabrasDaninas: ["Est√°s equivocado,", "Capit√°n Cometa es aburrido,"], corazonesIniciales: 4, tipo: "desacuerdo" },
            { id: 3, nombre: "La Felicitaci√≥n", personaje: "Sara", avatar: "üòä", mensajeOriginal: "¬°Miren el castillo de bloques que constru√≠!", ingredientes: ["El m√≠o es mejor.", "¬°Wow, Sara!", "¬°Qu√© incre√≠ble!", "Te qued√≥ genial."], solucion: ["¬°Wow, Sara!", "¬°Qu√© incre√≠ble!", "Te qued√≥ genial."], palabrasDaninas: ["El m√≠o es mejor."], corazonesIniciales: 4, tipo: "felicitacion" },
            { id: 4, nombre: "Malentendido en el Juego", personaje: "Marco", avatar: "üò†", mensajeOriginal: "¬°Perdimos por tu culpa! ¬°No me pasaste la pelota a tiempo!", ingredientes: ["No es mi culpa,", "T√∫ eres el malo,", "Entiendo que est√©s frustrado,", "pero todos somos un equipo.", "la pr√≥xima vez lo haremos mejor.", "¬°C√°lmate!"], solucion: ["Entiendo que est√©s frustrado,", "pero todos somos un equipo.", "la pr√≥xima vez lo haremos mejor."], palabrasDaninas: ["No es mi culpa,", "T√∫ eres el malo,", "¬°C√°lmate!"], corazonesIniciales: 1, tipo: "conflicto" },
            { id: 5, nombre: "La Pregunta Confusa", personaje: "Luc√≠a", avatar: "üòü", mensajeOriginal: "No entend√≠ nada de la tarea, ¬øalguien me ayuda? Me siento tonta.", ingredientes: ["Es muy f√°cil,", "No te preocupes,", "a m√≠ tambi√©n me cost√≥ al principio.", "¬øQuieres que lo repasemos juntos por videollamada?", "Lee otra vez.", "Luc√≠a,"], solucion: ["No te preocupes,", "Luc√≠a,", "a m√≠ tambi√©n me cost√≥ al principio.", "¬øQuieres que lo repasemos juntos por videollamada?"], palabrasDaninas: ["Es muy f√°cil,", "Lee otra vez."], corazonesIniciales: 2, tipo: "ayuda" }
        ];

        // --- VARIABLES DE ESTADO DEL JUEGO ---
        let currentScenarioIndex = 0;
        let cauldronWords = [];
        let totalHearts = 0;
        let stats = { consuelo: 0, desacuerdo: 0, felicitacion: 0, conflicto: 0, ayuda: 0 };

        // --- SELECTORES DEL DOM ---
        const introScreen = document.getElementById('intro-screen');
        const gameScreen = document.getElementById('game-screen');
        const winScreen = document.getElementById('win-screen');
        const startGameBtn = document.getElementById('start-game-btn');
        const cauldron = document.getElementById('cauldron');
        const ingredientsContainer = document.getElementById('ingredients-container');
        // ... (otros selectores)
        const scenarioTitle = document.getElementById('scenario-title');
        const characterAvatar = document.getElementById('character-avatar');
        const characterName = document.getElementById('character-name');
        const heartMeter = document.getElementById('heart-meter');
        const originalMessage = document.getElementById('original-message');
        const sendBtn = document.getElementById('send-btn');
        const resetBtn = document.getElementById('reset-btn');
        const progressIndicator = document.getElementById('progress-indicator');
        const rulesBtn = document.getElementById('rules-btn');
        const rulesModal = document.getElementById('rules-modal');
        const feedbackModal = document.getElementById('feedback-modal');
        
        // --- SONIDOS (Base64 para ser autocontenido) - VERSI√ìN MEJORADA ---
        const positiveSound = new Audio("data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU"+Array(30).join("123456789987654321"));
        const negativeSound = new Audio("data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU"+Array(30).join("987654321123456789"));
        const neutralSound = new Audio("data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU"+Array(20).join("112233445566778899"));

        // --- FUNCIONES PRINCIPALES ---
        function initGame() {
            // ... (listeners existentes)
            startGameBtn.addEventListener('click', startGame);
            document.getElementById('play-again-btn').addEventListener('click', () => location.reload());
            rulesBtn.addEventListener('click', showRules);
            rulesModal.querySelector('.close-btn').addEventListener('click', hideRules);
            feedbackModal.querySelector('.close-feedback-btn').addEventListener('click', hideFeedback);
            document.addEventListener('keydown', e => { if (e.key === 'Backspace' && !gameScreen.classList.contains('hidden')) undoLastIngredient(); });

            // Listeners para Drag & Drop en el Caldero
            cauldron.addEventListener('dragover', e => e.preventDefault());
            cauldron.addEventListener('drop', handleCauldronDrop);
        }

        function startGame() {
            introScreen.classList.add('hidden');
            gameScreen.classList.remove('hidden');
            currentScenarioIndex = 0;
            totalHearts = 0;
            renderScenario(currentScenarioIndex);
        }

        function renderScenario(index) {
            clearCauldron();
            const scenario = scenarios[index];
            scenarioTitle.textContent = `Desaf√≠o ${scenario.id}: ${scenario.nombre}`;
            characterAvatar.textContent = scenario.avatar;
            characterName.textContent = scenario.personaje;
            originalMessage.textContent = `"${scenario.mensajeOriginal}"`;
            progressIndicator.textContent = `Escenario ${index + 1} de ${scenarios.length}`;
            updateHeartMeter(scenario.corazonesIniciales, true);
            
            ingredientsContainer.innerHTML = '';
            scenario.ingredientes.forEach(ing => {
                const btn = document.createElement('button');
                btn.className = 'ingredient';
                btn.textContent = ing;
                btn.draggable = true;
                btn.setAttribute('role', 'button');
                btn.setAttribute('aria-label', `A√±adir ingrediente: ${ing}`);
                btn.addEventListener('click', () => addIngredient(ing, btn));
                btn.addEventListener('keydown', e => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); addIngredient(ing, btn); } });
                btn.addEventListener('dragstart', e => { e.dataTransfer.setData('text/plain', ing); });
                ingredientsContainer.appendChild(btn);
            });
        }
        
        // --- MANEJO DE INTERACCI√ìN ---

        /**
         * A√±ade un ingrediente al caldero y deshabilita el bot√≥n.
         */
        function addIngredient(word, element) {
            if (element && element.classList.contains('disabled')) return;
            cauldronWords.push(word);
            if (element) element.classList.add('disabled');
            renderCauldron();
        }

        /**
         * Renderiza el caldero, haciendo cada palabra arrastrable para reordenar.
         */
        function renderCauldron() {
            cauldron.innerHTML = '';
            cauldronWords.forEach((word, index) => {
                const wordEl = document.createElement('div');
                wordEl.className = 'cauldron-word';
                wordEl.textContent = word;
                wordEl.draggable = true;
                
                // Eventos para reordenar dentro del caldero
                wordEl.addEventListener('dragstart', e => {
                    e.dataTransfer.setData('source-index', index);
                    setTimeout(() => wordEl.classList.add('dragging'), 0);
                });
                wordEl.addEventListener('dragend', () => wordEl.classList.remove('dragging'));

                cauldron.appendChild(wordEl);
            });
        }
        
        /**
         * Maneja el evento de soltar (drop) en el caldero.
         * Diferencia entre a√±adir un nuevo ingrediente y reordenar uno existente.
         */
        function handleCauldronDrop(e) {
            e.preventDefault();
            const sourceIndexStr = e.dataTransfer.getData('source-index');

            if (sourceIndexStr !== "") { // Es un reordenamiento
                const sourceIndex = parseInt(sourceIndexStr, 10);
                const draggedWord = cauldronWords[sourceIndex];
                
                // Encuentra el elemento sobre el que se est√° soltando para determinar la nueva posici√≥n
                const afterElement = getDragAfterElement(cauldron, e.clientX);

                // Elimina el elemento de su posici√≥n original
                cauldronWords.splice(sourceIndex, 1);

                if (afterElement == null) {
                    cauldronWords.push(draggedWord); // A√±adir al final
                } else {
                    const newIndex = cauldronWords.indexOf(afterElement.textContent);
                    cauldronWords.splice(newIndex, 0, draggedWord); // Insertar antes del elemento destino
                }
                renderCauldron();
            } else { // Es un nuevo ingrediente
                const word = e.dataTransfer.getData('text/plain');
                const sourceElement = Array.from(ingredientsContainer.children).find(child => child.textContent === word);
                if (sourceElement && !sourceElement.classList.contains('disabled')) {
                    addIngredient(word, sourceElement);
                }
            }
        }
        
        /**
         * Helper para determinar qu√© elemento en el caldero est√° justo despu√©s 
         * de la posici√≥n del cursor durante un arrastre.
         */
        function getDragAfterElement(container, x) {
            const draggableElements = [...container.querySelectorAll('.cauldron-word:not(.dragging)')];

            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = x - box.left - box.width / 2;
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }


        function undoLastIngredient() {
            if (cauldronWords.length === 0) return;
            const lastWord = cauldronWords.pop();
            const ingredientBtn = Array.from(ingredientsContainer.children).find(btn => btn.textContent === lastWord);
            if (ingredientBtn) ingredientBtn.classList.remove('disabled');
            renderCauldron();
        }

        function clearCauldron() {
            cauldronWords = [];
            renderCauldron();
            Array.from(ingredientsContainer.children).forEach(btn => btn.classList.remove('disabled'));
        }

        // --- L√ìGICA DE EVALUACI√ìN Y FEEDBACK (SIN CAMBIOS) ---
        resetBtn.addEventListener('click', clearCauldron);
        sendBtn.addEventListener('click', evaluateMessage);
        
        function evaluateMessage() {
            const scenario = scenarios[currentScenarioIndex];
            const builtMessage = cauldronWords.join(" ");
            const solutionMessage = scenario.solucion.join(" ");
            const hasHarmfulWords = cauldronWords.some(word => scenario.palabrasDaninas.includes(word));

            if (hasHarmfulWords) applyFeedback('error');
            else if (builtMessage === solutionMessage) applyFeedback('success');
            else applyFeedback('neutral');
        }

        function applyFeedback(type) {
            const scenario = scenarios[currentScenarioIndex];
            let icon, title, lexiVoice, newHearts;
            
            feedbackModal.className = 'modal-overlay ' + type;

            switch (type) {
                case 'success':
                    positiveSound.play(); icon = '‚ú®'; title = '¬°Hechizo de Amabilidad Lanzado!';
                    lexiVoice = (scenario.tipo === 'desacuerdo') ? '¬°Excelente! Se puede estar en desacuerdo sin dejar de ser amigos.' : '¬°Has hecho sentir bien a tu amigo!';
                    newHearts = (scenario.tipo === 'desacuerdo') ? scenario.corazonesIniciales : 5;
                    stats[scenario.tipo]++;
                    totalHearts += (newHearts - (heartMeter.querySelectorAll('.full').length));
                    setTimeout(nextScenario, 2000);
                    break;
                case 'error':
                    negativeSound.play(); icon = 'üíî'; title = '¬°Cuidado, Mensajero!';
                    lexiVoice = '¬°Esas palabras atacaron a tu amigo, no a su idea! ¬°Su coraz√≥n se ha da√±ado!';
                    newHearts = 1;
                    break;
                case 'neutral':
                    neutralSound.play(); icon = 'ü§î'; title = 'Casi, casi...';
                    lexiVoice = 'El hechizo no tuvo el efecto esperado. Revisa el orden de los ingredientes o si te falta alguno. ¬°Int√©ntalo de nuevo!';
                    newHearts = scenario.corazonesIniciales;
                    break;
            }
            
            updateHeartMeter(newHearts);
            document.getElementById('feedback-icon').textContent = icon;
            document.getElementById('feedback-title').textContent = title;
            document.getElementById('feedback-lexi-voice').textContent = `Lexi dice: "${lexiVoice}"`;
            feedbackModal.classList.remove('hidden');
            feedbackModal.querySelector('.btn').focus();
        }

        function updateHeartMeter(count, isInitial = false) {
            heartMeter.innerHTML = '';
            heartMeter.setAttribute('aria-label', `Medidor de Coraz√≥n: ${count} de 5 corazones.`);
            for (let i = 0; i < 5; i++) {
                const heart = document.createElement('span');
                heart.className = 'heart';
                heart.innerHTML = i < count ? '&#x2764;' : '&#x2764;';
                if (i < count) heart.classList.add('full');
                if (!isInitial && i < count) heart.style.animation = 'heart-beat 0.5s ease-in-out';
                heartMeter.appendChild(heart);
            }
            if (count === 1) {
                heartMeter.children[0].classList.add('cracked');
                heartMeter.children[0].innerHTML = '&#x1F494;';
            }
        }

        function nextScenario() {
            currentScenarioIndex++;
            if (currentScenarioIndex < scenarios.length) renderScenario(currentScenarioIndex);
            else showWinScreen();
        }
        
        function showWinScreen() {
            gameScreen.classList.add('hidden');
            winScreen.classList.remove('hidden');
            const winStats = document.getElementById('win-stats');
            winStats.innerHTML = `Hoy consolaste a <strong>${stats.consuelo}</strong> amigo(s), expresaste <strong>${stats.desacuerdo}</strong> desacuerdo(s) con respeto, felicitaste a <strong>${stats.felicitacion}</strong> compa√±ero(s), resolviste <strong>${stats.conflicto}</strong> malentendido(s) y ofreciste <strong>${stats.ayuda}</strong> vez/veces tu ayuda. ¬°Has llenado el Foro con magia positiva!`;
            const confettiContainer = document.getElementById('confetti-container');
            confettiContainer.innerHTML = '';
            for(let i=0; i<50; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + 'vw';
                confetti.style.animationDelay = Math.random() * 5 + 's';
                confetti.style.backgroundColor = ['#f6b93b', '#4a47a3', '#706fd3', '#ff4757'][Math.floor(Math.random()*4)];
                confettiContainer.appendChild(confetti);
            }
        }

        // --- FUNCIONES DE MODALES ---
        function showRules() { rulesModal.classList.remove('hidden'); }
        function hideRules() { rulesModal.classList.add('hidden'); }
        function hideFeedback() { feedbackModal.classList.add('hidden'); }
        
        // --- INICIAR EL JUEGO ---
        initGame();
    });
    </script>
</body>
</html>
